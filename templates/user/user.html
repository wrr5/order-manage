<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>用户管理</title>
    <link rel="stylesheet" href="/static/css/bootstrap.min.css">
</head>

<body class="d-flex">
    {{template "navbar" .}}
    <main class="flex-grow-1 p-3">
        <div>
            <button class="btn btn-success" style="margin: 5px;" data-bs-toggle="modal"
                data-bs-target="#createUserModal">新增用户</button>
        </div>
        <div class="d-flex text-center">
            <div class="list-group flex-grow-1">
                {{range .users}}
                <div class="d-flex flex-column list-group-item">
                    <div>
                        姓名：{{.Name}} 手机号：{{.Phone}}
                    </div>

                    <div>
                        <button class="btn btn-warning" style="margin: 5px;" data-bs-toggle="modal"
                            data-bs-target="#userModal" onclick="editUser('{{.ID}}')">编辑</button>
                        <button class="btn btn-danger" style="margin: 5px;" data-bs-toggle="modal"
                            data-bs-target="#deleteConfirmModal">删除</button>
                    </div>
                </div>
                {{else}}
                <div>
                    <div class="list-group-item">暂无数据</div>
                </div>
                {{end}}
            </div>
        </div>
        <div class="mt-auto">
        </div>
    </main>

    <!-- 新增用户模态框 -->
    <div class="modal fade" id="createUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">新增用户</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="UserForm" method="post" action="/users">
                        <div class="mb-3">
                            <label for="name" class="form-label">姓名：</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone" class="form-label">手机号：</label>
                            <input type="text" class="form-control" id="phone" name="phone" required>
                        </div>
                        <div class="mb-3">
                            <label for="password" class="form-label">密码：</label>
                            <input type="password" class="form-control" id="password" name="password" required>
                        </div>
                        <div class="mb-3">
                            <label for="userType" class="form-label">用户类型：</label>
                            <select class="form-control" id="userType" name="userType" required>
                                <option value="">请选择</option>
                                <option value="customer_service_manager">客服主管</option>
                                <option value="customer_service">客服</option>
                                <option value="shop_owner">店长</option>
                                <option value="shop_employee">门店员工</option>
                                <option value="platform_owner">平台老板</option>
                            </select>
                        </div>

                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-success">创建</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">确认删除</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除吗？此操作不可恢复！</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" onclick="deleteUser()">确认删除</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 修改用户模态框 -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title" id="modalTitle">编辑用户</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form action=""></form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                    <button type="button" class="btn btn-primary" onclick="saveUser()">保存</button>
                </div>
            </div>
        </div>
    </div>
    <script src="/static/js/bootstrap.bundle.js"></script>
    <script>
        let currentDeleteId = null;

        // 获取模态框实例
        const userModal = new bootstrap.Modal(document.getElementById('userModal'));
        const deleteConfirmModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));

        function createUser() {
            // 获取表单元素
            const phone = document.getElementById('phone');

            // 前端验证
            if (!phone.value.trim()) {
                alert('手机号不能为空');
                phone.focus();
                return;
            }

            if (!/^\d{11}$/.test(phone.value.trim())) {
                alert('手机号必须是11位数字');
                phone.focus();
                return;
            }

            // 所有验证通过，准备数据
            const formData = {
                phone: phone.value.trim(),
            };

            // 发送AJAX请求到后端
            fetch('/auth/register', {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const createUserModal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                        createUserModal.hide();
                        alert("创建成功");
                        location.reload();
                    } else {
                        throw new Error(data.error || '创建失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('创建失败: ' + error.message);
                });
        }

        // 编辑用户
        function saveUser() {
            const formData = {
                id: document.getElementById('UserId').value,
                mobile: document.getElementById('phone').value,
            };

            // 发送AJAX请求到后端
            fetch('/user/' + formData.id, {
                method: "PUT",
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    return response.json().then(data => {
                        if (!response.ok) {
                            throw new Error(data.message || `请求失败，状态码: ${response.status}`);
                        }
                        return data;
                    });
                })
                .then(data => {
                    if (data.success) {
                        userModal.hide();
                        console.log('更新成功:', data);
                        location.reload();
                    } else {
                        throw new Error(data.message || '更新失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('保存失败: ' + error.message);
                });
        }

        // 删除用户
        function deleteUser() {
            if (!currentDeleteId) return;

            fetch('/user/' + currentDeleteId, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ id: currentDeleteId })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        deleteConfirmModal.hide();
                        alert("删除成功");
                        location.reload();
                    } else {
                        throw new Error(data.error || '创建失败');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('删除失败');
                });
        }

        // 模态框事件处理
        document.getElementById('createUserModal').addEventListener('shown.bs.modal', function () {
            document.getElementById('name').focus();
        });

        document.getElementById('deleteConfirmModal').addEventListener('hidden.bs.modal', function () {
            currentDeleteId = null;
        });
    </script>
</body>

</html>